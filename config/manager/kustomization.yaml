resources:
- manager.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
images:
- name: controller
  newName: ghcr.io/cobaltcore-dev/kvm-node-agent
  newTag: latest
patches:
- path: manager_node_selector_patch.yaml
  target:
    kind: DaemonSet
- patch: |-
    - op: add
      path: "/spec/template/spec/containers/0/env/-"
      value:
        name: NODE_LABEL
        valueFrom:
          fieldRef:
            fieldPath: "{{ .Values.controllerManager.manager.env.nodeLabelFieldPath }}"
    - op: add
      path: "/spec/template/spec/tolerations"
      value:
      - key: "node.gardener.cloud/critical-components-not-ready"
        operator: "Exists"
        effect: "NoSchedule"
  target:
    kind: DaemonSet
    name: controller-manager
    namespace: system
